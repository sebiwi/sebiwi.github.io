<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Tech, fun and cookies">

    <title>The Wizard: Side effects - Sebiwi</title>

    
    <link rel="stylesheet" href="/css/style.css">

    
    
    <meta property="og:title" content="The Wizard: Side effects">
    <meta property="og:description" content="Tech, fun and cookies">
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://localhost:1313/blog/the-wizard-side-effects/">
    <meta property="og:image" content="http://localhost:1313/images/wizard/wizard-1.jpg">

    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@sebiwicb">
    <meta name="twitter:title" content="The Wizard: Side effects">
    <meta name="twitter:description" content="Tech, fun and cookies">
    <meta name="twitter:image" content="http://localhost:1313/images/wizard/wizard-1.jpg">

    
    <meta name="color-scheme" content="light dark">
</head>
<body>
    <header class="site-header">
    <div class="container">
        <a href="/" class="site-title">Sebiwi</a>
        <nav class="site-nav">
            <a href="/blog/">Blog</a>
            <a href="/comics/">Comics</a>
            <a href="/tags/">Tags</a>
        </nav>
    </div>
</header>


    <main>
        
<article class="post">
    <div class="container">
        <header class="post-header">
            

            <h1 class="post-title">The Wizard: Side effects</h1>

            <div class="post-meta">
                <time datetime="2018-02-21">
                    Wednesday, February 21, 2018
                </time>

                
                <span class="read-time">5 min read</span>
                
            </div>

            
            
            <div class="post-tags">
                
                <a href="/tags/infrastructure-as-code" class="tag">infrastructure as code</a>
                
                <a href="/tags/software-craftsmanship" class="tag">software craftsmanship</a>
                
            </div>
            
            
        </header>

        <div class="post-content">
            <h3 id="he-has-questions">He has questions.</h3>
<p>Nevertheless, he has not yet arrived. And you know you have answers. You
interrupt your summoning, and sit down. You can continue in another moment.
Everything happens for a reason. You just hope the reason is good.</p>
<p>N appears right next to you.</p>
<ul>
<li>Hey, what’s up?</li>
<li>I&rsquo;m setting up the auto-scaling configuration of the new project. Nothing huge.</li>
<li>Cool. I need some help.</li>
</ul>
<p>He has progressed immensely since the last time you saw him. People are
starting to ask him for help now. You can’t help but feel pride when you see
what he has become.</p>
<ul>
<li>Yeah sure, show me.</li>
<li>Remember that nginx role you helped me create?</li>
<li>What about it?</li>
<li>It’s flawed.</li>
</ul>
<p>Interesting. He did realize after all.</p>
<ul>
<li>Is it, now?</li>
<li>Yes. I usually run my Ansible playbooks every night, in order to ensure that
all my infrastructure and services are at a certain state. At least the ones
in charge of server and middleware configuration.</li>
</ul>
<p>That’s good stuff, you think.</p>
<ul>
<li>That’s good stuff.</li>
<li>It is. It works as long as my playbooks are idempotent.</li>
<li>Are your playbooks idempotent?</li>
<li>Yes, except for the ones I use for application deployment.</li>
<li>What’s your issue then?</li>
<li>My nginx role. The service stopped unexpectedly, and my role wouldn’t restart it.</li>
</ul>
<p>He realized the hard way. That is probably a good thing. It is the best way to
learn.</p>
<ul>
<li>Okay. Let’s take a look.</li>
</ul>
<p>You summon the enclosure you both worked on on that occasion. You need it in
order to properly analyze the spell. You check the structure of it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># tasks/main.yml</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install epel-release</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">epel-release</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">notify</span>: <span style="color:#ae81ff">Start nginx</span>
</span></span></code></pre></div><p>It all comes back to you. You remember noticing the little issue with this
proposal. It was a time bomb. But then again, he found it. It’s precisely what
you wanted.</p>
<ul>
<li>Well, you’re only starting your service when installing nginx.</li>
<li>Yes.</li>
<li>So if your service is stopped, and you launch your playbook again, nothing
will change when nginx is already installed.</li>
<li>Yes. So this whole testing thing… I don’t think it’s a good idea. I
refactored my code, the tests passed, and the service is not running in
production because of a side effect.</li>
</ul>
<p>Patience is key.</p>
<ul>
<li>Did you test that side effect?</li>
<li>Well… no. How could I? It’s a side effect.</li>
<li>Write the code that would cause your side effect, and then see if your actual
code is able to handle that scenario.</li>
</ul>
<p>He considers the idea for half a second.</p>
<ul>
<li>So I’m supposed to put code which makes my components fail inside of my role?
That doesn’t make any sense, does it?</li>
<li>You don’t put it inside your role. You put it alongside your code. Watch.</li>
</ul>
<p>You reflect for a second, structuring your thoughts, trying to imagine exactly
what you need. You analyze the dimensions of the enclosure. Depth, width and
height. It won’t suffice for what you have in mind. Once you figure it out, you
close your eyes, and expand the enclosure in order to create a new dimension,
invisible to the naked eye. Inside this new pocket within time and space, you
place the side effect of the spell, just as he described it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># molecule/default/side_effect.yml</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Stop nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">all</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Stop nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">state</span>: <span style="color:#ae81ff">stopped</span>
</span></span></code></pre></div><p>This will probably suffice, you say to yourself.</p>
<ul>
<li>Would you say this code is capable of recreating the side effect you described earlier?</li>
<li>Yes, I would.</li>
<li>Great, let’s use it now.</li>
</ul>
<p>You concentrate as you modify the structure and logic of the enclosure in order
to use the new dimension:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># molecule/default/molecule.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scenario</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">test_sequence</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">destroy</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">syntax</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">lint</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">converge</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">side_effect</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">converge</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">idempotence</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">verify</span>
</span></span></code></pre></div><ul>
<li>So we’re converging twice?</li>
<li>Yes. You need to test whether your code is able to correct the state of your
component after a side effect.</li>
<li>Yes, indeed.</li>
<li>Now, launch your test.</li>
</ul>
<p>N claps his hands, and as he separates them, a stream of bright red light
appears between them:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>    <span style="color:#f92672">===================================</span> FAILURES <span style="color:#f92672">===================================</span>
</span></span><span style="display:flex;"><span>    __________________ test_nginx_is_running<span style="color:#f92672">[</span>ansible://instance<span style="color:#f92672">]</span> ___________________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span> &lt;testinfra.host.Host object at 0x108390290&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        def test_nginx_is_running<span style="color:#f92672">(</span>host<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Given</span>
</span></span><span style="display:flex;"><span>            nginx <span style="color:#f92672">=</span> host.service<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;nginx&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Then</span>
</span></span><span style="display:flex;"><span>    &gt;       assert nginx.is_running
</span></span><span style="display:flex;"><span>    E       assert False
</span></span><span style="display:flex;"><span>    E        +  where False <span style="color:#f92672">=</span> &lt;service nginx&gt;.is_running
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tests/test_default.py:20: AssertionError
</span></span></code></pre></div><p>He looks stunned for a while.</p>
<ul>
<li>So we weren’t testing the whole way, were we?</li>
<li>No, we weren’t. I mean, we were not testing for all of the edge cases we
could have had. You can’t possibly test for all of them. There’s way too
many. This was an interesting one though.</li>
<li>I see.</li>
<li>Well, you’re in red again. Go to green.</li>
</ul>
<p>N modifies the spell structure.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># tasks/main.yml</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tasks file for nginx-tdd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install epel-release</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">epel-release</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Start nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">started</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>It looks good.</p>
<ul>
<li>And now let me test…</li>
</ul>
<p>N does exactly the same thing he did before. Only this time, bright green light
emanates from his palms:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>    <span style="color:#f92672">=============================</span> test session starts <span style="color:#f92672">==============================</span>
</span></span><span style="display:flex;"><span>    platform darwin -- Python 2.7.11, pytest-3.3.2, py-1.5.2, pluggy-0.6.0
</span></span><span style="display:flex;"><span>    rootdir: /Users/sebiwi/stuff/ocac/skool-ops/craftmanship-ops/ansible-tdd/ansible-nginx-tdd/molecule/default, inifile:
</span></span><span style="display:flex;"><span>    plugins: testinfra-1.7.1
</span></span><span style="display:flex;"><span>collected <span style="color:#ae81ff">3</span> items
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tests/test_default.py ...                                                <span style="color:#f92672">[</span>100%<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">===========================</span> <span style="color:#ae81ff">3</span> passed in 7.78 seconds <span style="color:#f92672">===========================</span>
</span></span><span style="display:flex;"><span>Verifier completed successfully.
</span></span></code></pre></div><p>N looks at you.</p>
<ul>
<li>That was simple.</li>
<li>Was it?</li>
<li>I mean, I could have made my tests better from the beginning.</li>
<li>One bug in production is just a thing you didn’t test.</li>
<li>It seems like overkill for a simple nginx installation though.</li>
</ul>
<p>He is right. But he needs to see the bigger picture.</p>
<ul>
<li>It probably is. But now you know that you’re really testing interesting
scenarios, the ones you really want. Besides, think about it. The
possibilities are endless.</li>
<li>What do you mean?</li>
<li>You only have a single node component here, but you can use the same
principle in order to test incredibly complex things.</li>
<li>Such as?</li>
<li>High availability on distributed components, leader election, node failover…
you name it. You can simulate a disaster on a side effect and see how your
code will react to it.</li>
</ul>
<p>He reflects. He’s starting to get it.</p>
<ul>
<li>Can I help you with anything else?</li>
</ul>
<p>Your attention already shifted back to your summoning. What now?</p>
<ul>
<li>No, I think that will do. I’ll probably go add this to my other playbooks.
You’re right, the possibilities are…</li>
</ul>
<p>You’re no longer there again. N looks around in confusion.</p>
<ul>
<li>How does he do that ?</li>
</ul>

        </div>

        
<nav class="post-navigation">
    
    <a href="/blog/kubernetes-vs-docker-volumes/" class="post-nav-prev">
        <span class="post-nav-label">&laquo; Previous</span>
        <span class="post-nav-title">Kubernetes vs Docker: Volumes!</span>
    </a>
    

    
    <a href="/blog/the-wizard-scenarios/" class="post-nav-next">
        <span class="post-nav-label">Next &raquo;</span>
        <span class="post-nav-title">The Wizard: Scenarios</span>
    </a>
    
</nav>



        
        

<section class="related-posts">
    <h3>Related Posts</h3>
    <div class="related-grid">
        
        <article class="related-card">
            <a href="/blog/the-wizard-ansible-molecule-and-test-driven-development/">
                <h4>The Wizard: Ansible, Molecule and Test Driven Development</h4>
                <time datetime="2017-11-20">
                    Nov 20, 2017
                </time>
            </a>
        </article>
        
        <article class="related-card">
            <a href="/blog/ansible-reporting-with-ara-ansible-run-analysis/">
                <h4>Ansible reporting with ARA: Ansible Run Analysis</h4>
                <time datetime="2017-10-30">
                    Oct 30, 2017
                </time>
            </a>
        </article>
        
        <article class="related-card">
            <a href="/blog/how-does-it-work-docker-episode-5-get-some-workers-done/">
                <h4>How does it work? Docker! Episode 5 - Get some work(ers) done!</h4>
                <time datetime="2017-10-16">
                    Oct 16, 2017
                </time>
            </a>
        </article>
        
    </div>
</section>


        

        
        <aside class="author-info">
    <img src="/images/profile.jpg" alt="Sebiwi" class="author-avatar">
    <div class="author-details">
        <h4 class="author-name">Sebiwi</h4>
        <p class="author-bio">Tech, fun, and cookies</p>
        <div class="social-links">
    
    <a href="https://twitter.com/sebiwicb" target="_blank" rel="noopener" aria-label="Twitter">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
        </svg>
    </a>
    

    
    <a href="https://github.com/sebiwi" target="_blank" rel="noopener" aria-label="GitHub">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
        </svg>
    </a>
    

    
    <a href="mailto:contact.sebiwi@gmail.com" aria-label="Email">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
    </a>
    
</div>

    </div>
</aside>

        
    </div>
</article>

    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="social-links">
    
    <a href="https://twitter.com/sebiwicb" target="_blank" rel="noopener" aria-label="Twitter">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
        </svg>
    </a>
    

    
    <a href="https://github.com/sebiwi" target="_blank" rel="noopener" aria-label="GitHub">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
        </svg>
    </a>
    

    
    <a href="mailto:contact.sebiwi@gmail.com" aria-label="Email">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
    </a>
    
</div>

        <p class="copyright">&copy; 2025 Sebiwi</p>
    </div>
</footer>


    
    <script src="/js/animations.js"></script>
    
</body>
</html>
