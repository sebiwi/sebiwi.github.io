<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Tech, fun and cookies">

    <title>Ansible Container: Chronicle of a death foretold - Sebiwi</title>

    
    <link rel="stylesheet" href="/css/style.css">

    
    
    <meta property="og:title" content="Ansible Container: Chronicle of a death foretold">
    <meta property="og:description" content="Tech, fun and cookies">
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://localhost:1313/blog/ansible-container-chronicle-of-a-death-foretold/">
    

    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@sebiwicb">
    <meta name="twitter:title" content="Ansible Container: Chronicle of a death foretold">
    <meta name="twitter:description" content="Tech, fun and cookies">
    

    
    <meta name="color-scheme" content="light dark">
</head>
<body>
    <header class="site-header">
    <div class="container">
        <a href="/" class="site-title">Sebiwi</a>
        <nav class="site-nav">
            <a href="/blog/">Blog</a>
            <a href="/comics/">Comics</a>
            <a href="/tags/">Tags</a>
        </nav>
    </div>
</header>


    <main>
        
<article class="post">
    <div class="container">
        <header class="post-header">
            

            <h1 class="post-title">Ansible Container: Chronicle of a death foretold</h1>

            <div class="post-meta">
                <time datetime="2018-06-07">
                    Thursday, June 07, 2018
                </time>

                
                <span class="read-time">11 min read</span>
                
            </div>

            
            
            <div class="post-tags">
                
                <a href="/tags/infrastructure-as-code" class="tag">infrastructure as code</a>
                
            </div>
            
            
        </header>

        <div class="post-content">
            <p><strong>This article was co-written by the great <a href="https://blog.octo.com/author/adrien-besnard-bes/">Adrien Besnard</a></strong>.</p>
<p>Alright, here’s what’s up:</p>
<h2 id="tldr">TL;DR</h2>
<p>We tried Ansible Container. We’d rather keep using Dockerfiles for image
builds: creating a Docker image and provisioning servers with Ansible are two
very different things. Different in terms of lifecycle, philosophy and
workflow. So different, that in our opinion, they’re not compatible.</p>
<p>Wanna know why? Read on.</p>
<p>Disclaimer! While the current status of Ansible Container is not clear, it
seems that during the writing of this article the tool has <a href="https://github.com/ansible/ansible-container/commit/2fa778a7c8d1699672314ac0b89c53554f435cb7">been deprecated</a>.
After the limitations we noticed, we won&rsquo;t say that we didn&rsquo;t see that
coming&hellip;</p>
<h2 id="friendly-reminders-because-were-friendly">Friendly reminders (because we’re friendly)</h2>
<h3 id="ansible">Ansible</h3>
<p>Ansible is an automation software which allows you to do provisioning,
configuration and deployment tasks. Everything is written in a neat, simple,
easily readable YAML format, which is way better than old school Bash scripts.
But it remains code, Infrastructure as Code.</p>
<p>We won’t go deep into the details but we can say it has been a game-changer
regarding automated configuration and deployment because of its simplicity: you
only need SSH access to a server and that’s all. Every action is done from a
centralized server (which can be your computer, but it’s usually a CI/CD server
such as Jenkins) which connects to the other servers using SSH in order to
execute actions (most of the time, that means running Python code). Simple,
easy, efficient.</p>
<p>One of the cool abstraction of Ansible are the Roles which are a way to
describe how to setup an application without knowing the target host in
advance, in a reusable way.</p>
<h3 id="docker">Docker</h3>
<p>Docker is the de-facto container management tool. It allows you to build and
manage images, from which you can create containers. You can use Docker to do
this last part too if you want. Usually, when developing using a
container-oriented workflow, you will use Docker in order to package your
application.</p>
<p>Sadly, the process of creating Docker images isn’t perfect. This, for example,
is the sample Dockerfile used in order to create an Elasticsearch image:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">openjdk:8-jre</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># grab gosu for easy step-down from root</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> GOSU_VERSION 1.10<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> set -x <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> wget -O /usr/local/bin/gosu <span style="color:#e6db74">&#34;https://github.com/tianon/gosu/releases/download/</span>$GOSU_VERSION<span style="color:#e6db74">/gosu-</span><span style="color:#66d9ef">$(</span>dpkg --print-architecture<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> wget -O /usr/local/bin/gosu.asc <span style="color:#e6db74">&#34;https://github.com/tianon/gosu/releases/download/</span>$GOSU_VERSION<span style="color:#e6db74">/gosu-</span><span style="color:#66d9ef">$(</span>dpkg --print-architecture<span style="color:#66d9ef">)</span><span style="color:#e6db74">.asc&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> export GNUPGHOME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>mktemp -d<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> gpg --keyserver ha.pool.sks-keyservers.net --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> rm -rf <span style="color:#e6db74">&#34;</span>$GNUPGHOME<span style="color:#e6db74">&#34;</span> /usr/local/bin/gosu.asc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> chmod +x /usr/local/bin/gosu <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> gosu nobody true<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> set -ex; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e"># https://artifacts.elastic.co/GPG-KEY-elasticsearch</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    key<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;46095ACC8548582C1A2699A9D27D666CD88E42B4&#39;</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    export GNUPGHOME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>mktemp -d<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    gpg --keyserver ha.pool.sks-keyservers.net --recv-keys <span style="color:#e6db74">&#34;</span>$key<span style="color:#e6db74">&#34;</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    gpg --export <span style="color:#e6db74">&#34;</span>$key<span style="color:#e6db74">&#34;</span> &gt; /etc/apt/trusted.gpg.d/elastic.gpg; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    rm -rf <span style="color:#e6db74">&#34;</span>$GNUPGHOME<span style="color:#e6db74">&#34;</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apt-key list<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-repositories.html</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># https://www.elastic.co/guide/en/elasticsearch/reference/5.0/deb.html</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> set -x <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get install -y --no-install-recommends apt-transport-https <span style="color:#f92672">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#39;deb https://artifacts.elastic.co/packages/5.x/apt stable main&#39;</span> &gt; /etc/apt/sources.list.d/elasticsearch.list<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> ELASTICSEARCH_VERSION 5.6.8<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> ELASTICSEARCH_DEB_VERSION 5.6.8<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> set -x <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#75715e"># don&#39;t allow the package to install its sysctl file (causes the install to fail)</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Failed to write &#39;262144&#39; to &#39;/proc/sys/vm/max_map_count&#39;: Read-only file system</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#f92672">&amp;&amp;</span> dpkg-divert --rename /usr/lib/sysctl.d/elasticsearch.conf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> apt-get update <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> apt-get install -y --no-install-recommends <span style="color:#e6db74">&#34;elasticsearch=</span>$ELASTICSEARCH_DEB_VERSION<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> PATH /usr/share/elasticsearch/bin:$PATH<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span> <span style="color:#e6db74">/usr/share/elasticsearch</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> set -ex <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">for</span> path in <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        ./data <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        ./logs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        ./config <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        ./config/scripts <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    ; <span style="color:#66d9ef">do</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        mkdir -p <span style="color:#e6db74">&#34;</span>$path<span style="color:#e6db74">&#34;</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        chown -R elasticsearch:elasticsearch <span style="color:#e6db74">&#34;</span>$path<span style="color:#e6db74">&#34;</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#66d9ef">done</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> config ./config<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">VOLUME</span> <span style="color:#e6db74">/usr/share/elasticsearch/data</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> docker-entrypoint.sh /<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span> <span style="color:#e6db74">9200</span> <span style="color:#ae81ff">9300</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;/docker-entrypoint.sh&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;elasticsearch&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>It makes you want to die, doesn’t it? It’s complex, verbose and hard to
interpret. What are the logic steps involved in the construction of this image?
If you spend some (a lot) of time reading this Dockerfile in order to
understand what it does, you will realize that it starts from an openjdk image,
it installs gosu, and then it does a lot of things in order to install
Elasticsearch.</p>
<h3 id="ansible-container">Ansible Container</h3>
<p>Now imagine this: you work with your infrastructure in the cloud, and you
configure and deploy everything using Ansible. You have a huge galaxy of roles
that allow you to do many things related to your application (like installing
Java and Zookeeper, to name a few). You want to transform your workflow in
order to start using a container-based approach, but you don’t want to lose all
your Ansible resources.</p>
<p>What if instead of doing all that, you do this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">host</span>: <span style="color:#ae81ff">container</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">roles</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">gosu</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">elasticsearch</span>
</span></span></code></pre></div><p>Wouldn’t that be great? Wouldn’t it? Yes it would.</p>
<p>So we started looking around and we realized that there’s a tool called Ansible
Container.</p>
<p>From its homepage:</p>
<pre tabindex="0"><code>WHY NOT BUILD YOUR CONTAINERS WITH ANSIBLE PLAYBOOKS? NOW YOU CAN.

Ansible Container represents an end to the command &amp;&amp; command &amp;&amp; command (and
so on) syntax you’ve been struggling with to build containers.
</code></pre><p>Sounds pretty good, doesn’t it? Let’s take a look into it.</p>
<h2 id="lets-play">Let’s play!</h2>
<p>In order to play with Ansible Container, we’re going to deploy our own simple
Scala application which uses ZooKeeper in order to manage its state.</p>
<h3 id="our-application">Our application</h3>
<p>Our application is dead simple:</p>
<ul>
<li>First, it reads its configuration from the /etc/archiver.conf file</li>
<li>For each cycle on configured frequency, it looks for files under the
configured directory. If it finds any, it compresses them and then it deletes
the original files</li>
</ul>
<p>The fun part is that you can launch as many instances of the application as you
want, and only one of them will do the compression/deletion tasks. That’s what
Zookeeper is used for.</p>
<p>In order to make the application communicate with Zookeeper, we use Apache
Curator, which is a Zookeeper library. It provides many utilities we can use in
order to provide distributed lock policies and leader election.</p>
<p>You can see the code of our application here:
<a href="https://gitlab.octo.com/abesnard/ansible-container-zookeeper-article/tree/provision-virtual-machines/archiver">https://gitlab.octo.com/abesnard/ansible-container-zookeeper-article/tree/provision-virtual-machines/archiver</a>.</p>
<p>We wanted to create an application that needs Zookeeper because it seemed like
a coherent test case provided the assumptions stated before: we have an
Ansible-managed workflow, on virtual machines, and we’re moving towards a
container-based approach.</p>
<h4 id="the-ansible-role">The Ansible Role</h4>
<p>The Ansible Role is fairly simple:</p>
<ul>
<li>We create a user which will be used in order to run our application</li>
<li>We copy the JAR</li>
<li>We create the configuration file using some Ansible variables</li>
<li>And finally we run everything using systemd</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">create system user</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">user</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;archiver&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">system</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">home</span>: <span style="color:#e6db74">&#34;/usr/lib/archiver&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">create directories</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">owner</span>: <span style="color:#e6db74">&#34;archiver&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#34;archiver&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">directory</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">with_items</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;/usr/lib/archiver&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">copy JAR file</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">copy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">src</span>: <span style="color:#e6db74">&#34;archiver.jar&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;/usr/lib/archiver/archiver.jar&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">owner</span>: <span style="color:#e6db74">&#34;archiver&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#34;archiver&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">copy_jar_file</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">create config file</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">copy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">content</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    archiver {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        input-folder-path = &#34;{{ archiver_input_folder_path }}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        output-folder-path = &#34;{{ archiver_output_folder_path }}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        tick-period = {{ archiver_tick_period_in_seconds }} seconds
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{<span style="color:#ae81ff">% raw %}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">zookeeper.servers = [</span>
</span></span><span style="display:flex;"><span>        {{ <span style="color:#ae81ff">archiver_zookeeper_servers | map(&#39;quote&#39;) | join(&#39;, &#39;) }}</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>{<span style="color:#ae81ff">% endraw %}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">lock.timeout = {{ archiver_lock_timeout_in_seconds }} seconds</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dest</span>: <span style="color:#e6db74">&#34;/etc/archiver.conf&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">owner</span>: <span style="color:#e6db74">&#34;archiver&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#34;archiver&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">create_config_file</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">create systemd service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">copy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">content</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    [Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Description=Archiver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    [Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    owner=archiver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Group=archiver
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ExecStart=/usr/bin/java -jar &#34;/usr/lib/archiver/archiver.jar&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    dest: &#34;/etc/systemd/system/archiver.service&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">create_systemd_service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">reload systemd</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">systemd</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">daemon_reload</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">create_systemd_service.changed</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">start systemd service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">systemd</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;archiver.service&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">started</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">restart systemd service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">systemd</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;archiver.service&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">restarted</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">create_systemd_service.changed or create_config_file.changed or copy_jar_file.changed</span>
</span></span></code></pre></div><h3 id="zookeeper">ZooKeeper</h3>
<p>In a few words: ZooKeeper is a distributed and resilient key-value store. It
also provides some abstractions, making it a great solution in order to have a
distributed lock&hellip; which is exactly what we want because we only want one
instance of our Archiver application to run compression/deletion tasks at a
time.</p>
<h4 id="the-ansible-role-1">The Ansible role</h4>
<p>Because we do not want to reinvent the wheel, we’re going to use an existing
Ansible role from the Ansible Galaxy in order to provision ZooKeeper on our
machines : <a href="https://galaxy.ansible.com/AnsibleShipyard/ansible-zookeeper/">https://galaxy.ansible.com/AnsibleShipyard/ansible-zookeeper/</a>.</p>
<p>It’s a little bit off-topic, but Ansible Galaxy is a great tool which you can
use to organize and centralize your roles. More information here: <a href="https://galaxy.ansible.com/">https://galaxy.ansible.com/</a>!</p>
<h3 id="end-to-end">End to end</h3>
<p>Our playbook looks quite simple :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{<span style="color:#ae81ff">% raw %}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">install ZooKeeper</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">become</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">become_method</span>: <span style="color:#ae81ff">sudo</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">zookeeper</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">roles</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">role</span>: <span style="color:#e6db74">&#34;AnsibleShipyard.ansible-zookeeper&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">zookeeper_hosts</span>: <span style="color:#e6db74">&#34;{{ groups[&#39;zookeeper&#39;] | map(&#39;extract&#39;, hostvars, [&#39;ansible_&#39; + iface, &#39;ipv4&#39;, &#39;address&#39;]) | list }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">zookeeper_version</span>: <span style="color:#ae81ff">3.4.12</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">install Archiver</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">archiver</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">become</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">become_method</span>: <span style="color:#ae81ff">sudo</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">roles</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">role</span>: <span style="color:#e6db74">&#34;archiver&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">archiver_zookeeper_servers</span>: <span style="color:#e6db74">&#34;{{ groups[&#39;zookeeper&#39;] | map(&#39;extract&#39;, hostvars, [&#39;ansible_&#39; + iface, &#39;ipv4&#39;, &#39;address&#39;]) | list }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">archiver_input_folder_path</span>: <span style="color:#e6db74">&#34;/shared/to-archive&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">archiver_output_folder_path</span>: <span style="color:#e6db74">&#34;/shared/archived&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">archiver_tick_period_in_seconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">archiver_lock_timeout_in_seconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>{<span style="color:#ae81ff">% endraw %}</span>
</span></span></code></pre></div><p>As you can see, it works great on our two Vagrant boxes (it takes some time
because of the downloads of Java and ZooKeeper, but if you skip to the end&hellip;
Everything goes fine!) :</p>
<script type="text/javascript" src="https://asciinema.org/a/186568.js" id="asciicast-186568" async></script>
<h2 id="the-use-case">The Use-Case</h2>
<h3 id="first-try">First Try</h3>
<p>As we said before, a perfect use-case of Ansible Container is to leverage on
all the roles which have already been created in order to Dockerize existing
applications. So let’s do it: we’re going to containerize ZooKeeper and our
Archiver application&hellip;</p>
<p>We first write a container.yml file like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">settings</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">conductor</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">base</span>: <span style="color:#ae81ff">ubuntu:xenial</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">project_name</span>: <span style="color:#ae81ff">ansible-container-blog</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">zookeeper</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span>: <span style="color:#ae81ff">ubuntu:xenial</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">roles</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">role</span>: <span style="color:#e6db74">&#34;AnsibleShipyard.ansible-zookeeper&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">zookeeper_version</span>: <span style="color:#ae81ff">3.4.12</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">archiver</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span>: <span style="color:#ae81ff">ubuntu:xenial</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">roles</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">role</span>: <span style="color:#e6db74">&#34;archiver&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">archiver_zookeeper_servers</span>: [ <span style="color:#e6db74">&#34;zookeeper&#34;</span> ]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">archiver_input_folder_path</span>: <span style="color:#e6db74">&#34;/shared/to-archive&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">archiver_output_folder_path</span>: <span style="color:#e6db74">&#34;/shared/archived&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">archiver_tick_period_in_seconds</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">archiver_lock_timeout_in_seconds</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">zookeeper</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">links</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">zookeeper</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">/tmp/shared:/shared</span>
</span></span></code></pre></div><p>Let’s try it, and see what’s going on!</p>
<script type="text/javascript" src="https://asciinema.org/a/186571.js" id="asciicast-186571" async></script>
<p>It does not work, because we need to add some stuff in our role in order to
make it Docker compliant: Instead of having systemd to start a daemon, we need
to provide a Docker CMD.</p>
<p>If we take a step back, it’s easy to say that most of your roles are not ready
to be used as-is in a container using Ansible Container: multiple tasks are
relevant only in the context of classic servers (systemd services, firewall,
mounts, etc.). It’s due to the fact that Ansible is more that a tool to install
applications: it goes way beyond this simple use case&hellip; which is not relevant
in a Docker context.</p>
<p>Note that Ansible is aware of this problematic and that’s why the notion of
Container-Enabled Role has been created:
<a href="https://docs.ansible.com/ansible-container/roles/galaxy.html">https://docs.ansible.com/ansible-container/roles/galaxy.html</a>. So when you use
Ansible Galaxy, be aware of that!</p>
<h3 id="second-try">Second Try</h3>
<p>Fine&hellip; We’re going to make our role compliant:</p>
<ul>
<li>First, add when: ansible_env.ANSIBLE_CONTAINER is not defined in the step
which are not relevant in a container context (so in our case, everything
which is related to systemd)</li>
<li>Then add a meta/container.yml file in our Ansible role in order to tell
Ansible Container what is the actual CMD which needs to be run:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span>: <span style="color:#e6db74">&#34;ubuntu:xenial&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">user</span>: <span style="color:#e6db74">&#34;archiver&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">command</span>: [ <span style="color:#e6db74">&#34;java&#34;</span>, <span style="color:#e6db74">&#34;-jar&#34;</span>, <span style="color:#e6db74">&#34;/usr/lib/archiver/archiver.jar&#34;</span> ]
</span></span></code></pre></div><p>And here we go again!</p>
<script type="text/javascript" src="https://asciinema.org/a/186576.js" id="asciicast-186576" async></script>
<p>It’s alive! You can even see the Docker images which have been created by
Ansible Container (everything is properly named and tagged, which is pretty
nice) and the Conductor images (which are used by Ansible Container under the
hood to provision the containers):</p>
<script type="text/javascript" src="https://asciinema.org/a/186578.js" id="asciicast-186578" async></script>
<p>Just for you to know: we lied to you. We actually didn’t use the
AnsibleShipyard.ansible-zookeeper role as-is: we had to patch it for this
particular reason in order to continue our trial of Ansible Container:
<a href="https://gitlab.octo.com/abesnard/ansible-container-zookeeper-article/blob/build-containers-after-changes/ansible/roles/AnsibleShipyard.ansible-zookeeper.patch">https://gitlab.octo.com/abesnard/ansible-container-zookeeper-article/blob/build-containers-after-changes/ansible/roles/AnsibleShipyard.ansible-zookeeper.patch</a>.</p>
<p>Ansible Container even allows us to launch everything it created by creating an
Ansible playbook which actually starts the containers&hellip; Well, let’s do it!</p>
<script type="text/javascript" src="https://asciinema.org/a/186580.js" id="asciicast-186580" async></script>
<p>Pretty neat, right?</p>
<h2 id="reusage">Reusage</h2>
<h3 id="as-is">As-Is</h3>
<p>We just saw that with a few minor modifications of our role, we’re now capable
of using Ansible Container in order to produce Docker images instead of
actually deploying our role to some virtual machines.</p>
<p>Before going straight ahead to a Kubernetes cluster, we want to be sure that we
can reuse our newly created Docker image using Docker Compose. Easy, let’s
define our docker-compose.yml file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">zookeeper</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#34;zookeeper:latest&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">2181</span>:<span style="color:#ae81ff">2181</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">archiver</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#e6db74">&#34;ansible-container-blog-archiver&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;zookeeper&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;/tmp/shared:/shared:rw&#34;</span>
</span></span></code></pre></div><p>You can see that instead of leveraging of the ansible-container-blog-zookeeper
image, we’re going to use the official Docker image of ZooKeeper: it’s totally
possible because of the plug’n’play spirit of these images.</p>
<p>And run start Docker Compose:</p>
<script type="text/javascript" src="https://asciinema.org/a/186582.js" id="asciicast-186582" async></script>
<p>Everything is fine!</p>
<h3 id="update-configuration">Update configuration</h3>
<p>And now, what I want to do is to change the frequency of the file scan.</p>
<p>Well&hellip; we can’t actually do this without building the images using Ansible
Container again. And for us, this is the main issue of Ansible Container: an
Ansible role is fundamentally different from a Dockerfile.</p>
<h4 id="build-time-vs-run-time">Build Time V.S. Run Time</h4>
<p>And here we are&hellip; using our role (which heavily leverages Ansible’s template
module), we created a Docker image that is designed in order to work only in
the context of the architecture described in the container.yml file: the Docker
image we created cannot be used in a plug’n’play fashion. You cannot easily
reuse a Docker image which have been created with Ansible Container.</p>
<p>The cause of this is written in the /etc/archiver.conf file, all the value are
hardcoded in the Docker image:</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">archiver {
  input-folder-path = &#34;/shared/to-archive&#34;
  output-folder-path = &#34;/shared/archived&#34;
  tick-period = 10 seconds
}

zookeeper.servers = [
  zookeeper
]

lock.timeout = 1 seconds
</code></pre><p>The only way to update theses properties is to change the container.yml file
like this and rebuild everything&hellip; And we do think that it’s not a good
practice in a Docker context: we usually use environment variables to set or
override properties.</p>
<h2 id="wrap-up">Wrap Up</h2>
<h3 id="limitations">Limitations</h3>
<p>Ansible Container is not a bad tool and we actually think that it’s a good
idea: writing a Dockerfile is often a pain, and leveraging on Ansible could
have been a good idea.</p>
<p>But provisioning with Ansible heavily rely on the template module which sets the
properties during the provisioning, but do not permit to modify them afterward.
There is no such thing as Run Time with Ansible.</p>
<p>We didn’t cover that in this article, but Ansible Container is also bad at
caching stuff, which is a shame because it’s one of the best things that the
different Layers boughts by Docker provide&hellip;</p>
<h3 id="alternatives">Alternatives</h3>
<p>There are multiple ways to bypass this limitation:</p>
<ul>
<li>The best way is to update your application in order to make it aware of the
environment variables (this kind of behavior is native with multiple
configuration framework, like Spring :
<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html">https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html</a>
or Typesafe Config : <a href="https://github.com/lightbend/config">https://github.com/lightbend/config</a>) ;</li>
<li>Otherwise, before starting your application in your entrypoint.sh file, you
can use:
<ul>
<li>The envsubst program which will allow you to replace reference to any
environment variable by its value when called:
<a href="https://linux.die.net/man/1/envsubst">https://linux.die.net/man/1/envsubst</a></li>
<li>The confd program which is also a tool to fill a template using values,
except this time the values can come from other sources like Consul, etc.:
<a href="https://github.com/kelseyhightower/confd">https://github.com/kelseyhightower/confd</a>.</li>
</ul>
</li>
</ul>
<p>Please also note that if your Dockerfile is a mess because of the multiple
scripts it embeds, you still can put all the logic in a clean separate python
file&hellip; maybe this simple solution can also be a good start.</p>

        </div>

        
<nav class="post-navigation">
    
    <a href="/blog/the-wizard-scenarios/" class="post-nav-prev">
        <span class="post-nav-label">&laquo; Previous</span>
        <span class="post-nav-title">The Wizard: Scenarios</span>
    </a>
    

    
    <a href="/blog/software-craftsmanship-and-ops-scripting-a-love-story/" class="post-nav-next">
        <span class="post-nav-label">Next &raquo;</span>
        <span class="post-nav-title">Software Craftsmanship and OPS scripting: a love story</span>
    </a>
    
</nav>



        
        

<section class="related-posts">
    <h3>Related Posts</h3>
    <div class="related-grid">
        
        <article class="related-card">
            <a href="/blog/the-wizard-scenarios/">
                <h4>The Wizard: Scenarios</h4>
                <time datetime="2018-06-07">
                    Jun 07, 2018
                </time>
            </a>
        </article>
        
        <article class="related-card">
            <a href="/blog/the-wizard-side-effects/">
                <h4>The Wizard: Side effects</h4>
                <time datetime="2018-02-21">
                    Feb 21, 2018
                </time>
            </a>
        </article>
        
        <article class="related-card">
            <a href="/blog/the-wizard-ansible-molecule-and-test-driven-development/">
                <h4>The Wizard: Ansible, Molecule and Test Driven Development</h4>
                <time datetime="2017-11-20">
                    Nov 20, 2017
                </time>
            </a>
        </article>
        
    </div>
</section>


        

        
        <aside class="author-info">
    <img src="/images/profile.jpg" alt="Sebiwi" class="author-avatar">
    <div class="author-details">
        <h4 class="author-name">Sebiwi</h4>
        <p class="author-bio">Tech, fun, and cookies</p>
        <div class="social-links">
    
    <a href="https://twitter.com/sebiwicb" target="_blank" rel="noopener" aria-label="Twitter">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
        </svg>
    </a>
    

    
    <a href="https://github.com/sebiwi" target="_blank" rel="noopener" aria-label="GitHub">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
        </svg>
    </a>
    

    
    <a href="mailto:contact.sebiwi@gmail.com" aria-label="Email">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
    </a>
    
</div>

    </div>
</aside>

        
    </div>
</article>

    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="social-links">
    
    <a href="https://twitter.com/sebiwicb" target="_blank" rel="noopener" aria-label="Twitter">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
        </svg>
    </a>
    

    
    <a href="https://github.com/sebiwi" target="_blank" rel="noopener" aria-label="GitHub">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
        </svg>
    </a>
    

    
    <a href="mailto:contact.sebiwi@gmail.com" aria-label="Email">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
    </a>
    
</div>

        <p class="copyright">&copy; 2025 Sebiwi</p>
    </div>
</footer>


    
    <script src="/js/animations.js"></script>
    
</body>
</html>
