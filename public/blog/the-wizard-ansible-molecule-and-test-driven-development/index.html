<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Tech, fun and cookies">

    <title>The Wizard: Ansible, Molecule and Test Driven Development - Sebiwi</title>

    
    <link rel="stylesheet" href="/css/style.css">

    
    
    <meta property="og:title" content="The Wizard: Ansible, Molecule and Test Driven Development">
    <meta property="og:description" content="Tech, fun and cookies">
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://localhost:1313/blog/the-wizard-ansible-molecule-and-test-driven-development/">
    <meta property="og:image" content="http://localhost:1313/images/wizard/wizard-1.jpg">

    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@sebiwicb">
    <meta name="twitter:title" content="The Wizard: Ansible, Molecule and Test Driven Development">
    <meta name="twitter:description" content="Tech, fun and cookies">
    <meta name="twitter:image" content="http://localhost:1313/images/wizard/wizard-1.jpg">

    
    <meta name="color-scheme" content="light dark">
</head>
<body>
    <header class="site-header">
    <div class="container">
        <a href="/" class="site-title">Sebiwi</a>
        <nav class="site-nav">
            <a href="/blog/">Blog</a>
            <a href="/comics/">Comics</a>
            <a href="/tags/">Tags</a>
        </nav>
    </div>
</header>


    <main>
        
<article class="post">
    <div class="container">
        <header class="post-header">
            

            <h1 class="post-title">The Wizard: Ansible, Molecule and Test Driven Development</h1>

            <div class="post-meta">
                <time datetime="2017-11-20">
                    Monday, November 20, 2017
                </time>

                
                <span class="read-time">22 min read</span>
                
            </div>

            
            
            <div class="post-tags">
                
                <a href="/tags/infrastructure-as-code" class="tag">infrastructure as code</a>
                
                <a href="/tags/software-craftsmanship" class="tag">software craftsmanship</a>
                
            </div>
            
            
        </header>

        <div class="post-content">
            <h2 id="magic-has-existed-since-the-dawn-of-time">Magic has existed since the dawn of time.</h2>
<p>It has always been there, hidden in plain sight, making amazing things possible
for those willing to open their eyes and harness its power.</p>
<p>You can&rsquo;t remember the first time you used it, and yet it feels like you&rsquo;ve
never existed without it. You&rsquo;ve obliterated endless armies of enemies by
virtue of spells and enchantments, and you&rsquo;ve also constructed awe-inspiring
marvels from the ground up. As a result, you&rsquo;re renowned for your overwhelming
powers in every single one of your incarnations through time. Everyone knows
about <strong>the Wizard</strong>.</p>
<p>This affinity with magic grants you the ability to see the real nature of
things. Time for example, is not linear (as it was believed to be up until the
late 21st century). Sometimes, it is hard to keep up with it&hellip;</p>
<p>Suddenly you wake up. Or you come into consciousness. What year is it?</p>
<ul>
<li>So yeah, the output is still red, I really don’t know what else to do.</li>
<li>What?</li>
</ul>
<p>You look to your left. N is sitting right there. He looks at you with mild
concern in his eyes.</p>
<p><img src="/images/wizard/wizard-1.jpg" alt="Wizard"></p>
<ul>
<li>Are you okay?</li>
<li>Yeah, sorry.</li>
<li>As I was saying, I don’t know why this isn’t working.</li>
</ul>
<p>You look at the spell he is trying to cast. His intention is clear: he wants to
share the work of his clan with all the sentient entities in this reality by
means of a portal.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># task file for nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span></code></pre></div><h2 id="it-is-clear-why-he-is-failing">It is clear why he is failing.</h2>
<p>He is not taking into account the constraints of his clan’s environment. He
must first gather the requirements of his spell, and he’s not looking at the
right places. As a matter of fact, he is not looking at all. The answer is
simple. Nevertheless&hellip;</p>
<p>You reflect for a second, wondering if someone even taught N how to properly
cast a spell.</p>
<ul>
<li>How are you testing your role?</li>
<li>Hum…</li>
<li>Are you testing your role?</li>
<li>Yes, of course.</li>
<li>How?</li>
<li>I run my code on the target machine, and then I hope it doesn’t fail.</li>
</ul>
<p>You feel betrayed by the sound of his words. This is unacceptable. A whole
stack of death spells appear in your head. Breathe, you repeat to yourself. In.
Out. You keep going.</p>
<ul>
<li>Are you aware of the concept of Test-Driven Development?</li>
<li>Yeah, I used to work that way all the time when I was doing dev with the team.</li>
<li>So you’re familiar with it.</li>
<li>Sure, L taught me.</li>
</ul>
<p>Ah, a familiar name. You like L. You fought together at Desaix, before he
started mentoring his own apprentices on the arts of war. He must have taught N
a thing or two. You wonder if he will be capable of surviving the trial.</p>
<ul>
<li>Why don’t you test your code that way instead?</li>
<li>Because it is not Java, it’s Ansible.</li>
<li>So?</li>
<li>It’s not the same.</li>
<li>Let’s start over. Do you mind if I grab the keyboard?</li>
<li>Not at all.</li>
</ul>
<p>You harness your energy as you get ready to cast your first spell. You feel
alive again. You’re in familiar grounds. Before you start working, you need an
empty canvas, a playground to construct the structure and robustness of your
magic. An isolated enclosure which will allow you to try and cast your spells,
and which also follows the same rules as the target reality for the spell
you’re trying to create.</p>
<ul>
<li>Have you ever heard of Molecule?</li>
<li>&hellip;hum?</li>
<li>It’s a Python tool. It allows you to test your Ansible code on many different levels, using local infrastructure.</li>
<li>Local? Like a Virtual Machine?</li>
</ul>
<p>He’s fast. Time to make a choice. The Wanderer, or the Whale? The Whale is
indeed faster.</p>
<ul>
<li>Not necessarily. You can use different providers. Vagrant and Docker are the
most common if you want to work locally. We’re going to use Docker, since
containers have a faster start-up time.</li>
<li>Right on, Docker!</li>
</ul>
<p>The Whale it is. You concentrate and cast your first incantation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule init role --role-name nginx --driver-name docker
</span></span></code></pre></div><p>You feel the energy flowing through. A whirlpool of blue water forms in the
sky, and The Whale appears from inside of it. It comes swimming down through
the air, looking at you both, and sings its song loudly. An empty enclosure
materializes out of thin air, trapping you and N inside of it. The Whale
disappears from the whirlpool where it came, right before the whirlpool itself
vanishes into nothingness, as fast as it had appeared.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>--&gt; Initializing new role nginx…
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nginx/
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>├── defaults
</span></span><span style="display:flex;"><span>│   └── main.yml
</span></span><span style="display:flex;"><span>├── handlers
</span></span><span style="display:flex;"><span>│   └── main.yml
</span></span><span style="display:flex;"><span>├── meta
</span></span><span style="display:flex;"><span>│   └── main.yml
</span></span><span style="display:flex;"><span>├── molecule
</span></span><span style="display:flex;"><span>│   └── default
</span></span><span style="display:flex;"><span>│       ├── Dockerfile.j2
</span></span><span style="display:flex;"><span>│       ├── INSTALL.rst
</span></span><span style="display:flex;"><span>│       ├── create.yml
</span></span><span style="display:flex;"><span>│       ├── destroy.yml
</span></span><span style="display:flex;"><span>│       ├── molecule.yml
</span></span><span style="display:flex;"><span>│       ├── playbook.yml
</span></span><span style="display:flex;"><span>│       └── tests
</span></span><span style="display:flex;"><span>│           └── test_default.py
</span></span><span style="display:flex;"><span>├── tasks
</span></span><span style="display:flex;"><span>│   └── main.yml
</span></span><span style="display:flex;"><span>└── vars
</span></span><span style="display:flex;"><span>    └── main.yml
</span></span></code></pre></div><h2 id="you-feel-the-need-to-test-n">You feel the need to test N.</h2>
<p>He’s looking at what you’ve produced, his eyebrows frowning.</p>
<ul>
<li>What do you think? It’s the standard role structure, isn’t it? - you ask, naively</li>
<li>Yes, with the exception of the molecule directory with all of that stuff in it.</li>
</ul>
<p>Good. He realises there’s a difference. How can you easily explain the fact
that, in order to control such an enclosure, you need intermediate spells to
both create it and destroy it at will? You decide that it is not important
right now, you’ll come back later to it.</p>
<ul>
<li>Don’t think about it yet. Let’s see if our test framework is working properly.</li>
</ul>
<p>You concentrate and you cast the spell on the enclosure/playground.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    ├── destroy
</span></span><span style="display:flex;"><span>    ├── dependency
</span></span><span style="display:flex;"><span>    ├── syntax
</span></span><span style="display:flex;"><span>    ├── create
</span></span><span style="display:flex;"><span>    ├── converge
</span></span><span style="display:flex;"><span>    ├── idempotence
</span></span><span style="display:flex;"><span>    ├── lint
</span></span><span style="display:flex;"><span>    ├── side_effect
</span></span><span style="display:flex;"><span>    ├── verify
</span></span><span style="display:flex;"><span>    └── destroy
</span></span></code></pre></div><p>N is impressed by the fireworks. He has so many questions. You feel overjoyed,
but you give him a second so that he can get his ideas together.</p>
<ul>
<li>Test matrix? Default? And what are all of those things?</li>
<li>When I talked about testing Ansible code on many different levels, this is
what I meant. The default scenario is what gets executed when you type
<code>molecule test</code> on your terminal, and it contains all of these actions:
destroy, dependency, syntax, create, converge, idempotence…</li>
<li>Yeah, I can read.</li>
</ul>
<h4 id="snarky">Snarky.</h4>
<p>He wants you to know he’s not a child. He contemplates the enclosure’s
structure. You wait for a while until he starts talking again.</p>
<ul>
<li>Are these… actions executed in order?</li>
<li>Yes, unless you say otherwise.</li>
<li>What do you mean?</li>
</ul>
<p>You decide now is the time to go down the rabbit hole.</p>
<ul>
<li>Since I typed <code>molecule test</code>, molecule executes the default test sequence,
which corresponds to all of these actions. We can also redefine different
sequences for different targets if the default test sequence does not satisfy
our testing criteria.</li>
<li>Different sequences? Like skipping all tests? Or executing only… let’s say… the linting?</li>
<li>Sure.</li>
</ul>
<p>You raise your hand, and you snap your fingers. You hear warping sounds as the
enclosure somehow shifts. Everything looks the same, yet everything feels
different.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># molecule.yml</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">dependency</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">galaxy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">driver</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">docker</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">lint</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">yamllint</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">platforms</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">instance</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">centos:7</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">provisioner</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ansible</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lint</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ansible-lint</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scenario</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">test_sequence</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">lint</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">verifier</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">testinfra</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lint</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">flake8</span>
</span></span></code></pre></div><p>You take a deep breath, and you cast the spell again.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$  molecule test
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    └── lint
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;lint&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Executing Yamllint on files found in /private/tmp/test/nginx/...
</span></span><span style="display:flex;"><span>Lint completed successfully.
</span></span><span style="display:flex;"><span>--&gt; Executing Flake8 on files found in /private/tmp/test/nginx/molecule/default/tests/...
</span></span><span style="display:flex;"><span>Lint completed successfully.
</span></span><span style="display:flex;"><span>--&gt; Executing Ansible Lint on /private/tmp/test/nginx/molecule/default/playbook.yml...
</span></span><span style="display:flex;"><span>Lint completed successfully.
</span></span></code></pre></div><p>Once you’re finished, you look back at N. He gets where you’re going.</p>
<ul>
<li>That was faster.</li>
<li>Yes.</li>
<li>I think we should add some actions back though.</li>
<li>I agree. Which ones?</li>
<li>Let me see the first test matrix we saw.</li>
</ul>
<p>He studies the playground spells thoroughly.</p>
<ul>
<li>Why is the destroy action executed first?</li>
<li>Because the whole point is to be able to test that your role works in newly
created infrastructure.</li>
<li>Yeah, but it’s going to take longer if I need to create and destroy the
container each time I launch my test, right?</li>
</ul>
<p>Good. He is connecting the dots, seeing outside of the box. You decide that you
like N a little better now. Enough to keep the game going.</p>
<ul>
<li>Yes, but we will deal with that later. Just concentrate on the actions that
we should execute in order to fully test our role.</li>
<li>Okay, so then we need <code>destroy</code>&hellip; what is <code>dependency</code>?</li>
<li>It allows you to pull dependencies from the galaxy, if you need them.</li>
<li>Ah, let’s skip that then. What’s the difference between <code>syntax</code> and <code>lint</code>?</li>
<li>The <code>syntax</code> action runs your playbook using the <code>--syntax-check</code> option
native in Ansible, whereas <code>lint</code> checks your files using flake8, yamllint
and ansible-lint.</li>
<li>So <code>create</code> uses the create.yml file we just saw under the molecule directory
inside the role right?</li>
<li>Yes. It creates a Docker container suitable for Ansible use. And <code>destroy</code>
uses the destroy.yml file. They’re both playbooks, so these actions are
managed by Ansible.</li>
<li>Eat your own dog food, alright. So <code>converge</code> executes my role on the container?</li>
<li>That’s right.</li>
<li>What about <code>side-effect</code> and <code>verify</code>?</li>
<li><code>side-effect</code> lets you produce situations in which you will be able to test
more things, like HA failover, for example. I don’t think we’ll be needing
that one for this situation. And <code>verify</code> is where all the magic happens.
That’s where our unit tests get executed.</li>
<li>Unit tests? What?</li>
<li>You’ll see in a second.</li>
<li>Alright. So I guess we’ll need <code>destroy</code>, <code>syntax</code>, <code>lint</code>, <code>create</code>,
<code>converge</code>, <code>verify</code> and <code>destroy</code> again. No, wait. No destroy at the end.
That’s why it is at the beginning.</li>
<li>As you wish.</li>
</ul>
<p>You notice something is missing, but you decide to keep going to take advantage
of the synergy. You will get back to it, eventually. You snap your fingers once
again, altering the enclosure to match his words.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># molecule.yml</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">scenario</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">test_sequence</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">destroy</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">syntax</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">lint</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">converge</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">verify</span>
</span></span></code></pre></div><p>You cast the spell once again, using the modified reality of the enclosure. The
fireworks appear one more time, this time slightly smaller.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$  molecule test
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    ├── destroy
</span></span><span style="display:flex;"><span>    ├── syntax
</span></span><span style="display:flex;"><span>    ├── lint
</span></span><span style="display:flex;"><span>    ├── create
</span></span><span style="display:flex;"><span>    ├── converge
</span></span><span style="display:flex;"><span>    └── verify
</span></span></code></pre></div><h3 id="n-seems-happy">N seems happy.</h3>
<p>He understands how it works. You take advantage of his
motivation to feed him more knowledge.</p>
<ul>
<li>This is going to act as our full test scenario. We’re not going to run all of that every single time we test though.</li>
<li>Hum? Why not? What are we doing instead?</li>
</ul>
<p>Knowledge is power. Everyone knows that. If you’re able to acquire knowledge
faster, you’re able to acquire power faster as well.</p>
<ul>
<li>Because we want our feedback loop to be as short and quick as possible. So
we’re going to <code>create</code> our resources, <code>converge</code> them with our Ansible role,
and <code>verify</code> that the results are what we expect. You can do this by typing
<code>molecule create</code>, <code>molecule converge</code> and <code>molecule verify</code>. Then, if it all
works, we’re going to run our whole test sequence.</li>
</ul>
<p>You let that sink in for a while, hoping that he doesn’t give up. You look
outside the window. It’s raining. You like rain. At least on Earth. It’s better
than on Venus, where it melts the skin off of your bones if you don’t cast a
protection enchantment around you. That is if the temperature or the pressure
don’t get you first. N doesn’t give up. He looks at you.</p>
<ul>
<li>Okay, I think I have it. Let’s create the container.</li>
</ul>
<p>You start summoning The Whale again, but you only hear its song this time. It
is as loud as it was before. The enclosure disappears and reappears around you.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule create
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    └── create
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;create&#39;</span>
</span></span></code></pre></div><p>You look at N, and you think about the next steps. This is going to sound
familiar to him.</p>
<ul>
<li>Let’s run our tests. They are located on the test_default.py file, under the
molecule directory.</li>
</ul>
<p>You clap your hands once, loudly. As you separate them a stream of shiny green
light emanates from them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> $molecule verify
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    └── verify
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;verify&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Executing Testinfra tests found in /private/tmp/test/nginx/molecule/default/tests/...
</span></span><span style="display:flex;"><span>    Verifier completed successfully.
</span></span></code></pre></div><p>Everything is okay, for now. Back to N.</p>
<ul>
<li>What are the three steps of Test-Driven Development?</li>
<li>Red, green, refactor.</li>
</ul>
<p>L had done his job right.</p>
<ul>
<li>Excellent. What are you trying to accomplish?</li>
<li>I want to expose my web app using nginx.</li>
<li>What do you need for that?</li>
<li>Well, I need to install nginx.</li>
<li>Let&rsquo;s go to red then.</li>
</ul>
<p>You spawn a glob of energy with your hands and use it to craft a rule within
the enclosure’s reality:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> testinfra.utils.ansible_runner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>testinfra_hosts <span style="color:#f92672">=</span> testinfra<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>ansible_runner<span style="color:#f92672">.</span>AnsibleRunner(
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;MOLECULE_INVENTORY_FILE&#39;</span>])<span style="color:#f92672">.</span>get_hosts(<span style="color:#e6db74">&#39;all&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_nginx_is_installed</span>(host):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Given</span>
</span></span><span style="display:flex;"><span>    nginx <span style="color:#f92672">=</span> host<span style="color:#f92672">.</span>package(<span style="color:#e6db74">&#39;nginx&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> nginx<span style="color:#f92672">.</span>is_installed
</span></span></code></pre></div><ul>
<li>This feels familiar.</li>
<li>It&rsquo;s because it is.</li>
</ul>
<p>You clap your hands together, just as you did a minute ago. Nevertheless, red
shiny light appears this time as you separate them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule verify
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">===================================</span> FAILURES <span style="color:#f92672">===================================</span>
</span></span><span style="display:flex;"><span>_________________ test_nginx_is_installed<span style="color:#f92672">[</span>ansible://instance<span style="color:#f92672">]</span> __________________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span> &lt;testinfra.host.Host object at 0x10a9a7350&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    def test_nginx_is_installed<span style="color:#f92672">(</span>host<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Given</span>
</span></span><span style="display:flex;"><span>        nginx <span style="color:#f92672">=</span> host.package<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;nginx&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Then</span>
</span></span><span style="display:flex;"><span>&gt;       assert nginx.is_installed
</span></span><span style="display:flex;"><span>E       assert False
</span></span><span style="display:flex;"><span>E        +  where False <span style="color:#f92672">=</span> &lt;package nginx&gt;.is_installed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tests/test_default.py:14: AssertionError
</span></span></code></pre></div><ul>
<li>See? That&rsquo;s red. We&rsquo;re good. What&rsquo;s next?</li>
<li>Green. So now we&rsquo;ll add the task we need in order to install the server.</li>
</ul>
<p>You close your eyes and concentrate. The structure of the spell N had in the
first place is recreated from the ground.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tasks file for nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span></code></pre></div><p>Back to square one. It is now the same spell N had when he asked you for help.
You cast the spell, knowing what will happen beforehand.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> $molecule converge
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    ├── create
</span></span><span style="display:flex;"><span>    └── converge
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;create&#39;</span>
</span></span><span style="display:flex;"><span>Skipping, instances already created.
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;converge&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    TASK <span style="color:#f92672">[</span>nginx : Install nginx<span style="color:#f92672">]</span> ***************************************************
</span></span><span style="display:flex;"><span>    fatal: <span style="color:#f92672">[</span>instance<span style="color:#f92672">]</span>: FAILED! <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;changed&#34;</span>: false, <span style="color:#e6db74">&#34;failed&#34;</span>: true, <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;No package matching &#39;nginx&#39; found available, installed or updated&#34;</span>, <span style="color:#e6db74">&#34;rc&#34;</span>: 126, <span style="color:#e6db74">&#34;results&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;No package matching &#39;nginx&#39; found available, installed or updated&#34;</span><span style="color:#f92672">]}</span>
</span></span></code></pre></div><p>No fireworks. N seems discouraged. You think about giving him a little push. He
deserves it. It&rsquo;s not about the magic itself, it&rsquo;s about context. He&rsquo;s not
getting the sources for his portal from the right index. He needs the Epel
codex.</p>
<ul>
<li>At least it&rsquo;s easier to test now.</li>
<li>Don&rsquo;t be sad. The nginx package is contained within the epel-release repository.</li>
<li>What? You could have told me that from the beginning, couldn&rsquo;t you?</li>
<li>We wouldn&rsquo;t be talking about infrastructure testing if I had, would we?</li>
</ul>
<p>He smiles. He&rsquo;s getting in the game, getting the feel of the mindset. He likes
it.</p>
<ul>
<li>Let&rsquo;s try it again.</li>
</ul>
<p>You modify the structure of the spell once again, specifying that you want your
portal to be created following the instructions on the Epel codex.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tasks file for nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install epel release</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">epel-release</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span></code></pre></div><p>You cast the spell, with the new structure.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule converge
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    ├── create
</span></span><span style="display:flex;"><span>    └── converge
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;create&#39;</span>
</span></span><span style="display:flex;"><span>Skipping, instances already created.
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;converge&#39;</span>
</span></span><span style="display:flex;"><span>…
</span></span><span style="display:flex;"><span>    PLAY RECAP *********************************************************************
</span></span><span style="display:flex;"><span>    instance                   : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>The spell works, or at least it seems to work. The fireworks make the air
vibrate within the enclosure. N seems happy. He doesn&rsquo;t have the right reflexes
yet. Can you blame him? It&rsquo;s his first existence, and he&rsquo;s just starting to
play with magic. He won&rsquo;t realize that his portal is not yet active, he’s just
dazzled with the fireworks. It’s time for a new trial.</p>
<ul>
<li>Excellent! I guess we&rsquo;re done!</li>
<li>Yeah. Did you try it?</li>
<li>Oh right, let&rsquo;s see. Can I login to the container somehow?</li>
<li>Yeah, <code>molecule login</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@instance /<span style="color:#f92672">]</span><span style="color:#75715e"># curl localhost</span>
</span></span><span style="display:flex;"><span>curl: <span style="color:#f92672">(</span>7<span style="color:#f92672">)</span> Failed to connect to ::1: Cannot assign requested address
</span></span></code></pre></div><ul>
<li>Hm. But&hellip; ah, right! I never started the service.</li>
<li>Be my guest, add the missing code needed to do it.</li>
</ul>
<p>He is about to modify the spell’s structure, when he suddenly stops. He looks
at you.</p>
<ul>
<li>No. It&rsquo;s not the right way. Can&rsquo;t I test that first?</li>
</ul>
<p>He passed the test. He might make a good disciple. You start to understand why
L started teaching in the first place.</p>
<ul>
<li>Sure, just add another test.</li>
<li>Alright…</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_nginx_is_running</span>(host):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Given</span>
</span></span><span style="display:flex;"><span>    nginx <span style="color:#f92672">=</span> host<span style="color:#f92672">.</span>service(<span style="color:#e6db74">&#39;nginx&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> nginx<span style="color:#f92672">.</span>is_running
</span></span></code></pre></div><ul>
<li>I love writing tests in Python by the way. It’s way simpler than in Java.</li>
<li>Don’t let L hear you say that. Try it.</li>
</ul>
<p>You know the Whale won’t let N get away with that, but you want to see him try.
Failure is part of the learning process. It is almost more important than
success. It’s the only way he can learn to get up and keep trying.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule verify
</span></span><span style="display:flex;"><span>    E       AssertionError: Unexpected exit code <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">for</span> CommandResult<span style="color:#f92672">(</span>command<span style="color:#f92672">=</span>u<span style="color:#e6db74">&#39;systemctl is-active nginx&#39;</span>, exit_status<span style="color:#f92672">=</span>1, stdout<span style="color:#f92672">=</span>u<span style="color:#e6db74">&#39;&#39;</span>, stderr<span style="color:#f92672">=</span>u<span style="color:#e6db74">&#39;Failed to get D-Bus connection: Operation not permitted&#39;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>N claps his hands like you did before, but no light appears as he separated his
hands. He looks as you, confused.</p>
<ul>
<li>Hm, this doesn’t look like the good kind of red. It is not an assertion
error.</li>
<li>It is not. Testinfra (your Python unit testing library) uses Systemd, Upstart
or SysV in order to test if the services are running. Docker containers don’t
have an init system. They do have Tini, but it doesn’t work the same way.</li>
<li>So I need to change the image that I’m using. Is there a Centos image that
includes Systemd?</li>
<li>Yeah, it’s called centos/systemd.</li>
<li>Go figure. Where can I modify that?</li>
<li>On the molecule.yml file. You will need to specify the container’s command
instruction in order to start Systemd, because Molecule overrides it by
default. You will also need a privileged container, since Systemd requires
CAP_SYS_ADMIN and non-privileged containers do not have that capability.</li>
<li>Hum, I didn’t quite get all of that, but I think I’ll ask you about it again
tomorrow. Let me redo the configuration.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">platforms</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">instance</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">centos/systemd</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#ae81ff">/usr/sbin/init</span>
</span></span></code></pre></div><p>The Whale will surely accept this offering. You know it will not reject your
summoning anymore. N verifies the spell again.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule test
</span></span><span style="display:flex;"><span><span style="color:#f92672">===================================</span> FAILURES <span style="color:#f92672">===================================</span>
</span></span><span style="display:flex;"><span>____________ test_nginx_is_running_and_enabled<span style="color:#f92672">[</span>ansible://instance<span style="color:#f92672">]</span> _____________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span> &lt;testinfra.host.Host object at 0x110adff50&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    def test_nginx_is_running<span style="color:#f92672">(</span>host<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Given</span>
</span></span><span style="display:flex;"><span>        nginx <span style="color:#f92672">=</span> host.service<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;nginx&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Then</span>
</span></span><span style="display:flex;"><span>&gt;       assert nginx.is_running
</span></span><span style="display:flex;"><span>E       assert False
</span></span><span style="display:flex;"><span>E        +  where False <span style="color:#f92672">=</span> &lt;service nginx&gt;.is_running
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tests/test_default.py:20: AssertionError
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-- Docs: http://doc.pytest.org/en/latest/warnings.html
</span></span><span style="display:flex;"><span><span style="color:#f92672">================</span> <span style="color:#ae81ff">1</span> failed, <span style="color:#ae81ff">1</span> passed, <span style="color:#ae81ff">1</span> warnings in 6.74 seconds <span style="color:#f92672">================</span>
</span></span></code></pre></div><ul>
<li>Done, we&rsquo;re back to red. Now I&rsquo;ll make the changes in order to start the
service.</li>
</ul>
<p>You smile as you see N craft. He is not ready yet, but he is well under way.
You feel proud of him.</p>
<ul>
<li>Alright, I’m done. What do you think?</li>
</ul>
<p>He shows you the structure of his spell.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tasks file for nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install epel release</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">epel-release</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Start nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: <span style="color:#ae81ff">systemctl start nginx</span>
</span></span></code></pre></div><p>All of your previously found pride turns into disappointment. This is
preposterous. It can’t be serious. He can&rsquo;t be serious. He should understand
that you can&rsquo;t be spawning portals indefinitely. The results could be
catastrophic.</p>
<p>But then…you contemplate him. You realize he&rsquo;s tired. Idempotence is a hard
concept to grasp too. Benjamin Peirce taught it for over 50 years at Harvard.
You remember the first time Merlin brought you to an enclosure like this one.
Just the memory of it makes you feel goosebumps on the back of your neck.</p>
<p>You decide that you’re going to let him continue, for education purposes only.
He’ll realize the problem with his proposal.</p>
<ul>
<li>Why don’t you try it?</li>
</ul>
<p>He casts the spell himself.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule converge
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    ├── create
</span></span><span style="display:flex;"><span>    └── converge
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;create&#39;</span>
</span></span><span style="display:flex;"><span>Skipping, instances already created.
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;converge&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PLAY RECAP *********************************************************************
</span></span><span style="display:flex;"><span>    instance                   : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>Right after the fireworks, a green portal appears right in front of both of you. It seems to work.</p>
<ul>
<li>Great. I’ll verify now.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule verify
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    └── verify
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;verify&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Executing Testinfra tests found in /Users/sebiwi/stuff/test/nginx/molecule/default/tests/...
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">=============================</span> test session starts <span style="color:#f92672">==============================</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">=====================</span> <span style="color:#ae81ff">2</span> passed, <span style="color:#ae81ff">1</span> warnings in 6.70 seconds <span style="color:#f92672">=====================</span>
</span></span><span style="display:flex;"><span>Verifier completed successfully.
</span></span></code></pre></div><p>Green light everywhere.</p>
<ul>
<li>Perfect! Green!</li>
</ul>
<p>Or is it? You decide to give him a little push in the right direction.</p>
<ul>
<li>Try running the whole test suite.</li>
<li>Alright</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$molecule test
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    ├── destroy
</span></span><span style="display:flex;"><span>    ├── syntax
</span></span><span style="display:flex;"><span>    ├── lint
</span></span><span style="display:flex;"><span>    ├── create
</span></span><span style="display:flex;"><span>    ├── converge
</span></span><span style="display:flex;"><span>    └── verify
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;lint&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Executing Yamllint on files found in /Users/sebiwi/stuff/test/nginx/...
</span></span><span style="display:flex;"><span>Lint completed successfully.
</span></span><span style="display:flex;"><span>--&gt; Executing Flake8 on files found in /Users/sebiwi/stuff/test/nginx/molecule/default/tests/...
</span></span><span style="display:flex;"><span>Lint completed successfully.
</span></span><span style="display:flex;"><span>--&gt; Executing Ansible Lint on /Users/sebiwi/stuff/test/nginx/molecule/default/playbook.yml...
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>ANSIBLE0012<span style="color:#f92672">]</span> Commands should not change things <span style="color:#66d9ef">if</span> nothing needs doing
</span></span><span style="display:flex;"><span>    /Users/sebiwi/stuff/test/nginx/tasks/main.yml:14
</span></span><span style="display:flex;"><span>    Task/Handler: Start nginx
</span></span></code></pre></div><p>No fireworks, no lights.</p>
<ul>
<li>What? Oh, that’s just ansible-lint, it often fails for that sort of thing,
I’ll just deactivate it for the task.</li>
</ul>
<p>You stare in disbelief as N “corrects” the structure of the spell.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tasks file for nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install epel release</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">epel-release</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Start nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">command</span>: <span style="color:#ae81ff">systemctl start nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">skip_ansible_lint</span>
</span></span></code></pre></div><p>He finishes the modifications and he casts the spell once again.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$  molecule test
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    ├── destroy
</span></span><span style="display:flex;"><span>    ├── syntax
</span></span><span style="display:flex;"><span>    ├── lint
</span></span><span style="display:flex;"><span>    ├── create
</span></span><span style="display:flex;"><span>    ├── converge
</span></span><span style="display:flex;"><span>    └── verify
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>All steps completed successfully.
</span></span></code></pre></div><p>He looks at you proudly. You’re dismayed. He’s being naive and reckless. You
realize that it is time to handle the situation.</p>
<ul>
<li>We’re green now. I think we’re finished.</li>
<li>Not really. Previously, ansible-lint said that you’re changing things even if
nothing needs to be done.</li>
<li>Yeah, it’s because I was starting a service.</li>
<li>Yes, but since you’re not using an Ansible module, you’re executing an action
each time you run your playbook.</li>
<li>I thought Ansible was idempotent.</li>
<li>Not really. You can make idempotent code with Ansible. It doesn’t mean
everything you do with it is going to be idempotent. Some things are not
meant to be idempotent.</li>
<li>Like what?</li>
<li>Application deployments, for example. You’re deploying a new version of the
application. It is meant to change things.</li>
<li>I see. But this role should be idempotent.</li>
<li>Certainly. You can add a new action to your default scenario test suite in
order to test for idempotence.</li>
</ul>
<p>You close your eyes as you change the reality of the enclosure around you once again.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">scenario</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">test_sequence</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">destroy</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">syntax</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">lint</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">create</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">converge</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">idempotence</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">verify</span>
</span></span></code></pre></div><p>You cast the spell again.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$  molecule test
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    ├── destroy
</span></span><span style="display:flex;"><span>    ├── syntax
</span></span><span style="display:flex;"><span>    ├── lint
</span></span><span style="display:flex;"><span>    ├── create
</span></span><span style="display:flex;"><span>    ├── converge
</span></span><span style="display:flex;"><span>    ├── idempotence
</span></span><span style="display:flex;"><span>    └── verify
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;idempotence&#39;</span>
</span></span><span style="display:flex;"><span>ERROR: Idempotence test failed because of the following tasks:
</span></span><span style="display:flex;"><span>* <span style="color:#f92672">[</span>instance<span style="color:#f92672">]</span> <span style="color:#f92672">=</span>&gt; nginx : Start nginx
</span></span></code></pre></div><p>N looks at you.</p>
<ul>
<li>So we weren’t actually at green yet.</li>
<li>We weren’t. Idempotence is a behaviour of our code. It also needs testing.</li>
<li>I can fix it though.</li>
<li>Show me.</li>
</ul>
<p>You hand over the control of the enclosure to N. He modifies the spell
structure.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tasks file for nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install epel release</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">epel-release</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Start nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">started</span>
</span></span></code></pre></div><p>You smile with relief.</p>
<ul>
<li>Much better. Try it.</li>
<li>Right away.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$  molecule test
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    ├── destroy
</span></span><span style="display:flex;"><span>    ├── syntax
</span></span><span style="display:flex;"><span>    ├── lint
</span></span><span style="display:flex;"><span>    ├── create
</span></span><span style="display:flex;"><span>    ├── converge
</span></span><span style="display:flex;"><span>    ├── idempotence
</span></span><span style="display:flex;"><span>    └── verify
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>All steps completed successfully.
</span></span></code></pre></div><ul>
<li>And now we’re green.</li>
<li>Yes!</li>
<li>Let’s continue with our TDD approach. Red, Green, and&hellip; ?</li>
<li>Refactor! Do you see any possible improvements on this code?</li>
<li>Well, you could use your “Start nginx” task as a handler, which is triggered
by the installation of nginx, couldn’t you?</li>
<li>Yes, I could.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tasks file for nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install epel release</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">epel-release</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">notify</span>: <span style="color:#ae81ff">Start nginx</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># handlers file for nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Start nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">started</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$  molecule test
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    ├── destroy
</span></span><span style="display:flex;"><span>    ├── syntax
</span></span><span style="display:flex;"><span>    ├── lint
</span></span><span style="display:flex;"><span>    ├── create
</span></span><span style="display:flex;"><span>    ├── converge
</span></span><span style="display:flex;"><span>    ├── idempotence
</span></span><span style="display:flex;"><span>    └── verify
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>All steps completed successfully.
</span></span></code></pre></div><h3 id="n-looks-euphoric">N looks euphoric.</h3>
<p>He’s applying his well-earned war experience to a whole different situation,
and it is working like a charm. There’s a slight catch within your proposal,
but you decide that you will let him discover it by himself.</p>
<ul>
<li>Wow, that worked out great! What else?</li>
<li>You could have only one “yum” task and iterate over the packages that you want to install.</li>
<li>Good call.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tasks file for nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install epel-release and nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">yum</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">with_items</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">epel-release</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">Start nginx</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule test
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;converge&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PLAY <span style="color:#f92672">[</span>Converge<span style="color:#f92672">]</span> ****************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    TASK <span style="color:#f92672">[</span>Gathering Facts<span style="color:#f92672">]</span> *********************************************************
</span></span><span style="display:flex;"><span>    ok: <span style="color:#f92672">[</span>instance<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    TASK <span style="color:#f92672">[</span>nginx : Install epel-release and nginx<span style="color:#f92672">]</span> **********************************
</span></span><span style="display:flex;"><span>    failed: <span style="color:#f92672">[</span>instance<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>item<span style="color:#f92672">=[</span>u<span style="color:#e6db74">&#39;epel-release&#39;</span>, u<span style="color:#e6db74">&#39;nginx&#39;</span><span style="color:#f92672">])</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;changed&#34;</span>: false, <span style="color:#e6db74">&#34;failed&#34;</span>: true, <span style="color:#e6db74">&#34;item&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;epel-release&#34;</span>, <span style="color:#e6db74">&#34;nginx&#34;</span><span style="color:#f92672">]</span>, <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;No package matching &#39;nginx&#39; found available, installed or updated&#34;</span>, <span style="color:#e6db74">&#34;rc&#34;</span>: 126, <span style="color:#e6db74">&#34;results&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;No package matching &#39;nginx&#39; found available, installed or updated&#34;</span><span style="color:#f92672">]}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PLAY RECAP *********************************************************************
</span></span><span style="display:flex;"><span>    instance                   : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><ul>
<li>Hm. I guess I need to install epel-release before I can install nginx. It
doesn’t work if I do both at the same time.</li>
<li>True.</li>
<li>I wouldn’t had realized that without the tests. I would have done my
refactoring, and it would have worked, since epel-release would already be
installed on my machine when trying to install it along with nginx in a single
task.</li>
<li>Indeed. Also, with the current code structure, you’re not only starting nginx
after installing nginx, but also after installing epel-release.</li>
<li>Right. I shouldn’t. That was a test, wasn’t it?</li>
<li>Maybe.</li>
</ul>
<p>N transforms the spell structure back to its previous form. You feel relaxed.
You always feel this way after creating something impressive. You feel the same
way you felt when you structured the pyramids, only to a minor extent. This
time, however, the actual creator is N. You only acted as a catalyzer. The
knowledge was always inside of N, he just needed to hear the right questions.</p>
<p>N looks tired, but he wants to keep going.</p>
<ul>
<li>We just went through a full Red/Green/Refactor cycle. Sweet!</li>
<li>Do you want to do another one?</li>
<li>Absolutely!</li>
<li>What happens if your VM gets rebooted?</li>
<li>Nothing, nginx will still be installed.</li>
<li>Will it be running?</li>
<li>Oh, no. It won’t. Yikes.</li>
<li>You should enable it then. You know what to do.</li>
</ul>
<p>N creates a new rule within the enclosure’s reality.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_nginx_is_enabled</span>(host):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Given</span>
</span></span><span style="display:flex;"><span>    nginx <span style="color:#f92672">=</span> host<span style="color:#f92672">.</span>service(<span style="color:#e6db74">&#39;nginx&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> nginx<span style="color:#f92672">.</span>is_enabled
</span></span></code></pre></div><p>He claps his hands together. Red light appears everywhere.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule verify
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    └── verify
</span></span><span style="display:flex;"><span>--&gt; Scenario: <span style="color:#e6db74">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Action: <span style="color:#e6db74">&#39;verify&#39;</span>
</span></span><span style="display:flex;"><span>--&gt; Executing Testinfra tests found in /Users/sebiwi/stuff/test/nginx/molecule/default/tests/…
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">===================================</span> FAILURES <span style="color:#f92672">===================================</span>
</span></span><span style="display:flex;"><span>    __________________ test_nginx_is_enabled<span style="color:#f92672">[</span>ansible://instance<span style="color:#f92672">]</span> ___________________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span> &lt;testinfra.host.Host object at 0x103b20fd0&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       def test_nginx_is_enabled<span style="color:#f92672">(</span>host<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Given</span>
</span></span><span style="display:flex;"><span>            nginx <span style="color:#f92672">=</span> host.service<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;nginx&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Then</span>
</span></span><span style="display:flex;"><span>    &gt;       assert nginx.is_enabled
</span></span><span style="display:flex;"><span>    E       assert False
</span></span><span style="display:flex;"><span>    E        +  where False <span style="color:#f92672">=</span> &lt;service nginx&gt;.is_enabled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tests/test_default.py:28: AssertionError
</span></span><span style="display:flex;"><span>    -- Docs: http://doc.pytest.org/en/latest/warnings.html
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">================</span> <span style="color:#ae81ff">1</span> failed, <span style="color:#ae81ff">2</span> passed, <span style="color:#ae81ff">1</span> warnings in 7.29 seconds <span style="color:#f92672">================</span>
</span></span></code></pre></div><ul>
<li>Red.</li>
<li>Go for Green.</li>
</ul>
<p>N modifies the structure of the spell to match the new reality constraints.
He’s got a clear head now, he knows what is missing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># handlers file for nginx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Start nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">started</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">yes</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$  molecule test
</span></span><span style="display:flex;"><span>--&gt; Test matrix
</span></span><span style="display:flex;"><span>└── default
</span></span><span style="display:flex;"><span>    ├── destroy
</span></span><span style="display:flex;"><span>    ├── syntax
</span></span><span style="display:flex;"><span>    ├── lint
</span></span><span style="display:flex;"><span>    ├── create
</span></span><span style="display:flex;"><span>    ├── converge
</span></span><span style="display:flex;"><span>    ├── idempotence
</span></span><span style="display:flex;"><span>    └── verify
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>All steps completed successfully.
</span></span></code></pre></div><p>The green portal appears in front of you both. You know it is sustainable, you
both tested it thoroughly. It’s a proper wizard spell. People would say it is
one of your own. N looks at you and smiles.</p>
<ul>
<li>Green.</li>
<li>Yes. Can you refactor?</li>
<li>I don’t think so. It looks pretty clean to me.</li>
<li>I agree.</li>
</ul>
<h3 id="you-do-agree">You do agree.</h3>
<p>N seems in charge. He needs more time to develop himself, to
learn, to become comfortable with this whole new world. You won’t be as useful
during that period as you were now. It’s time to go.</p>
<ul>
<li>You know how to continue, right?</li>
<li>Yes, I think I can manage. This is pretty cool. Thanks.</li>
<li>No problem kid. Just call me if you need more help.</li>
<li>Will do. Hey, do you..?</li>
</ul>
<p>N looks at where you used to be 10 seconds ago. You are no longer there.</p>

        </div>

        
<nav class="post-navigation">
    
    <a href="/blog/ansible-reporting-with-ara-ansible-run-analysis/" class="post-nav-prev">
        <span class="post-nav-label">&laquo; Previous</span>
        <span class="post-nav-title">Ansible reporting with ARA: Ansible Run Analysis</span>
    </a>
    

    
    <a href="/blog/kubernetes-vs-docker-volumes/" class="post-nav-next">
        <span class="post-nav-label">Next &raquo;</span>
        <span class="post-nav-title">Kubernetes vs Docker: Volumes!</span>
    </a>
    
</nav>



        
        

<section class="related-posts">
    <h3>Related Posts</h3>
    <div class="related-grid">
        
        <article class="related-card">
            <a href="/blog/ansible-reporting-with-ara-ansible-run-analysis/">
                <h4>Ansible reporting with ARA: Ansible Run Analysis</h4>
                <time datetime="2017-10-30">
                    Oct 30, 2017
                </time>
            </a>
        </article>
        
        <article class="related-card">
            <a href="/blog/how-does-it-work-docker-episode-5-get-some-workers-done/">
                <h4>How does it work? Docker! Episode 5 - Get some work(ers) done!</h4>
                <time datetime="2017-10-16">
                    Oct 16, 2017
                </time>
            </a>
        </article>
        
        <article class="related-card">
            <a href="/blog/how-does-it-work-docker-episode-4-control-your-swarm/">
                <h4>How does it work? Docker! Episode 4 - Control your Swarm!</h4>
                <time datetime="2017-10-02">
                    Oct 02, 2017
                </time>
            </a>
        </article>
        
    </div>
</section>


        

        
        <aside class="author-info">
    <img src="/images/profile.jpg" alt="Sebiwi" class="author-avatar">
    <div class="author-details">
        <h4 class="author-name">Sebiwi</h4>
        <p class="author-bio">Tech, fun, and cookies</p>
        <div class="social-links">
    
    <a href="https://twitter.com/sebiwicb" target="_blank" rel="noopener" aria-label="Twitter">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
        </svg>
    </a>
    

    
    <a href="https://github.com/sebiwi" target="_blank" rel="noopener" aria-label="GitHub">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
        </svg>
    </a>
    

    
    <a href="mailto:contact.sebiwi@gmail.com" aria-label="Email">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
    </a>
    
</div>

    </div>
</aside>

        
    </div>
</article>

    </main>

    <footer class="site-footer">
    <div class="container">
        <div class="social-links">
    
    <a href="https://twitter.com/sebiwicb" target="_blank" rel="noopener" aria-label="Twitter">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
        </svg>
    </a>
    

    
    <a href="https://github.com/sebiwi" target="_blank" rel="noopener" aria-label="GitHub">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
        </svg>
    </a>
    

    
    <a href="mailto:contact.sebiwi@gmail.com" aria-label="Email">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
    </a>
    
</div>

        <p class="copyright">&copy; 2025 Sebiwi</p>
    </div>
</footer>


    
    <script src="/js/animations.js"></script>
    
</body>
</html>
